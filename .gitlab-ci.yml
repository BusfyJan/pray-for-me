image: node:9.11-alpine

stages:
    - lint
    - test
    - deploy

lint:
    stage: lint
    image: newtmitch/sonar-scanner:3.2.0-alpine
    script:
        - sonar-scanner \
            -Dsonar.projectKey=pray-for-me \
            -Dsonar.organization=busfyjan-github \
            -Dsonar.sources=. \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.login=43ecd7530f40dc8782222124cdfaacd28c0cd886

test:
    stage: test
    script:
        - export CI=true
        - npm install --unsafe-perm
        - npm test

deploy_development:
    stage: deploy
    environment:
        name: development
    only:
        - development
    script:
        - apk add --no-cache --update curl
        - npm install --unsafe-perm
        - npm run deploy:development
        
deploy_production:
    stage: deploy
    environment:
        name: production
    only:
        - master
    script:
        - apk add --no-cache --update curl
        - npm install --unsafe-perm
        - npm run deploy:production